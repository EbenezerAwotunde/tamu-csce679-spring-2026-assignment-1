<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hong Kong Monthly Temperature Matrix View</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            padding: 30px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
            color: #333;
            font-size: 28px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .toggle-btn {
            padding: 10px 20px;
            font-size: 14px;
            border: 2px solid #007bff;
            background-color: white;
            color: #007bff;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .toggle-btn.active {
            background-color: #007bff;
            color: white;
        }

        .toggle-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
        }

        .visualization {
            display: flex;
            gap: 30px;
            overflow-x: auto;
            padding: 20px 0;
        }

        .chart-section {
            flex-grow: 1;
        }

        svg {
            background-color: #fafafa;
            border-radius: 4px;
        }

        .matrix-cell {
            stroke: #ddd;
            stroke-width: 1px;
        }

        .matrix-cell:hover {
            stroke: #333;
            stroke-width: 2px;
            filter: brightness(1.05);
        }

        .year-label {
            font-size: 12px;
            font-weight: 600;
            text-anchor: middle;
            fill: #333;
        }

        .month-label {
            font-size: 12px;
            text-anchor: end;
            fill: #333;
        }

        .tooltip {
            position: absolute;
            padding: 10px 12px;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            max-width: 250px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .tooltip-date {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .tooltip-temp {
            color: #ffd700;
        }

        .legend {
            margin-top: 30px;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }

        .legend-title {
            font-weight: 600;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .legend-items {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border: 1px solid #999;
            border-radius: 3px;
        }

        .legend-gradient-bar {
            height: 30px;
            width: 300px;
            border: 2px solid #999;
            border-radius: 3px;
            position: relative;
            overflow: hidden;
        }

        .legend-min, .legend-max {
            font-size: 12px;
            font-weight: 600;
            position: absolute;
            top: -25px;
        }

        .legend-min {
            left: 0;
        }

        .legend-max {
            right: 0;
        }

        #legend-svg {
            display: block;
        }

        .mini-chart {
            fill: none;
            stroke: #4CAF50;
            stroke-width: 1px;
        }

        @media (max-width: 1024px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 24px;
            }

            .controls {
                gap: 10px;
            }

            .toggle-btn {
                padding: 8px 16px;
                font-size: 12px;
            }
        }

        .info-text {
            text-align: center;
            color: #666;
            font-size: 13px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Hong Kong Monthly Temperature Matrix View</h1>
        <p class="subtitle">Last 10 Years of Daily Temperature Data (2008-2017)</p>
        
        <div class="controls">
            <button class="toggle-btn active" data-type="max">Maximum Temperature</button>
            <button class="toggle-btn" data-type="min">Minimum Temperature</button>
        </div>

        <div class="visualization">
            <div class="chart-section">
                <svg id="matrix-chart"></svg>
            </div>
        </div>

        <div class="legend">
            <div class="legend-title">Temperature Color Legend</div>
            <div class="legend-items">
                <div style="width: 100%; text-align: center;">
                    <div style="width: 350px; margin: 0 auto; padding-top: 30px;">
                        <div class="legend-min">0°C</div>
                        <div class="legend-max">40°C</div>
                        <svg id="legend-svg" width="300" height="30" style="margin: 0 auto; display: block;"></svg>
                    </div>
                </div>
            </div>
            <p class="info-text" style="margin-top: 15px;">
                Click the temperature buttons to switch between maximum and minimum temperatures.
                Hover over cells to see detailed information.
            </p>
        </div>
    </div>

    <div class="tooltip"></div>

    <script>
        // Configuration 
        const CELL_SIZE = 80;
        const CELL_PADDING = 4;
        const MINI_CHART_HEIGHT = 15;
        const MARGIN = { top: 30, right: 20, bottom: 60, left: 80 };
        const MONTHS = ['January', 'February', 'March', 'April', 'May', 'June',
                       'July', 'August', 'September', 'October', 'November', 'December'];

        let currentMode = 'max';
        let data = [];
        let processedData = {};
        let years = [];

        // Color Scale 
        const colorScale = d3.scaleLinear()
            .domain([0, 10, 20, 30, 40])
            .range(['#4575b4', '#74add1', '#fee090', '#f46d43', '#a50026']);

        // Initialize Gradient Legend 
        function initLegendGradient() {
            const svg = d3.select('#legend-svg');
            const width = 300;
            const height = 30;

            // Create SVG gradient definition
            const defs = svg.append('defs');
            const gradientId = 'temp-gradient';
            const gradient = defs.append('linearGradient')
                .attr('id', gradientId)
                .attr('x1', '0%')
                .attr('x2', '100%');

            // Add color stops for the gradient
            const steps = [
                { offset: '0%', color: colorScale(0) },
                { offset: '25%', color: colorScale(10) },
                { offset: '50%', color: colorScale(20) },
                { offset: '75%', color: colorScale(30) },
                { offset: '100%', color: colorScale(40) }
            ];

            steps.forEach(step => {
                gradient.append('stop')
                    .attr('offset', step.offset)
                    .attr('stop-color', step.color);
            });

            // Draw the gradient rectangle
            svg.append('rect')
                .attr('width', width)
                .attr('height', height)
                .attr('fill', `url(#${gradientId})`)
                .attr('stroke', '#999')
                .attr('stroke-width', 2);
        }

        // ==================== Data Processing ====================
        function processData(rawData) {
            const tempData = {};

            rawData.forEach(d => {
                const date = new Date(d.date);
                const year = date.getFullYear();
                const month = date.getMonth();
                const key = `${year}-${month}`;

                if (!tempData[key]) {
                    tempData[key] = {
                        year: year,
                        month: month,
                        monthName: MONTHS[month],
                        dates: [],
                        maxTemps: [],
                        minTemps: []
                    };
                }

                tempData[key].dates.push(date);
                tempData[key].maxTemps.push(+d.max_temperature);
                tempData[key].minTemps.push(+d.min_temperature);
            });

            // Calculate aggregated values
            Object.keys(tempData).forEach(key => {
                const item = tempData[key];
                item.max_avg = d3.mean(item.maxTemps);
                item.min_avg = d3.mean(item.minTemps);
                item.max_month = d3.max(item.maxTemps);
                item.min_month = d3.min(item.minTemps);
            });

            processedData = tempData;

            // Extract unique years (last 10 years)
            const uniqueYears = [...new Set(Object.values(tempData).map(d => d.year))].sort();
            const lastTenYears = uniqueYears.slice(-10);
            years = lastTenYears;
        }

        // ==================== Main Visualization ====================
        function drawMatrix() {
            const svg = d3.select('#matrix-chart');
            svg.selectAll('*').remove();

            // Calculate dimensions
            const width = MARGIN.left + MARGIN.right + (years.length * (CELL_SIZE + CELL_PADDING));
            const height = MARGIN.top + MARGIN.bottom + (12 * (CELL_SIZE + CELL_PADDING));

            svg.attr('width', width).attr('height', height);

            const g = svg.append('g')
                .attr('transform', `translate(${MARGIN.left},${MARGIN.top})`);

            // Draw year labels
            years.forEach((year, i) => {
                const x = i * (CELL_SIZE + CELL_PADDING);
                g.append('text')
                    .attr('x', x + CELL_SIZE / 2)
                    .attr('y', -10)
                    .attr('class', 'year-label')
                    .text(year);
            });

            // Draw month labels and cells
            MONTHS.forEach((monthName, monthIdx) => {
                const y = monthIdx * (CELL_SIZE + CELL_PADDING);

                // Month label
                g.append('text')
                    .attr('x', -10)
                    .attr('y', y + CELL_SIZE / 2)
                    .attr('dy', '0.35em')
                    .attr('class', 'month-label')
                    .text(monthName);

                // Draw cells for each year
                years.forEach((year, yearIdx) => {
                    const x = yearIdx * (CELL_SIZE + CELL_PADDING);
                    const key = `${year}-${monthIdx}`;
                    const monthData = processedData[key];

                    if (!monthData) return;

                    const value = currentMode === 'max' ? monthData.max_avg : monthData.min_avg;
                    const color = colorScale(value);

                    // Main cell rectangle
                    g.append('rect')
                        .attr('x', x)
                        .attr('y', y)
                        .attr('width', CELL_SIZE)
                        .attr('height', CELL_SIZE)
                        .attr('class', 'matrix-cell')
                        .attr('fill', color)
                        .on('mouseenter', function(event) {
                            showTooltip(monthData, value, event);
                            d3.select(this).style('opacity', 0.8);
                        })
                        .on('mousemove', function(event) {
                            updateTooltipPosition(event);
                        })
                        .on('mouseleave', function() {
                            hideTooltip();
                            d3.select(this).style('opacity', 1);
                        });

                    // Draw mini line chart
                    drawMiniChart(g, monthData, x, y, currentMode);
                });
            });

            // Draw grid lines
            for (let i = 0; i <= years.length; i++) {
                const x = i * (CELL_SIZE + CELL_PADDING);
                g.append('line')
                    .attr('x1', x).attr('y1', 0)
                    .attr('x2', x).attr('y2', 12 * (CELL_SIZE + CELL_PADDING))
                    .attr('stroke', '#eee').attr('stroke-width', 1);
            }

            for (let i = 0; i <= 12; i++) {
                const y = i * (CELL_SIZE + CELL_PADDING);
                g.append('line')
                    .attr('x1', 0).attr('y1', y)
                    .attr('x2', years.length * (CELL_SIZE + CELL_PADDING)).attr('y2', y)
                    .attr('stroke', '#eee').attr('stroke-width', 1);
            }
        }

        // Mini Chart 
        function drawMiniChart(g, monthData, startX, startY, mode) {
            const temps = mode === 'max' ? monthData.maxTemps : monthData.minTemps;
            
            if (!temps || temps.length === 0) return;

            const xScale = d3.scaleLinear()
                .domain([0, temps.length - 1])
                .range([0, CELL_SIZE - 4]);

            const yScale = d3.scaleLinear()
                .domain([d3.min(temps) - 2, d3.max(temps) + 2])
                .range([MINI_CHART_HEIGHT, 0]);

            const line = d3.line()
                .x((d, i) => xScale(i))
                .y(d => yScale(d));

            const pathData = line(temps);

            g.append('path')
                .attr('d', pathData)
                .attr('class', 'mini-chart')
                .attr('transform', `translate(${startX + 2}, ${startY + CELL_SIZE - MINI_CHART_HEIGHT - 2})`);
        }

        // Tooltip Management 
        function showTooltip(monthData, value, event) {
            const tooltip = d3.select('.tooltip');
            const avgText = currentMode === 'max' ? 'Max Avg' : 'Min Avg';
            const maxText = currentMode === 'max' ? `Max: ${monthData.max_month}°C` : `Min: ${monthData.min_month}°C`;

            tooltip.html(`
                <div class="tooltip-date">${monthData.year} - ${monthData.monthName}</div>
                <div class="tooltip-temp">${avgText}: ${value.toFixed(1)}°C</div>
                <div class="tooltip-temp">${maxText}</div>
            `)
            .style('display', 'block');

            updateTooltipPosition(event);
        }

        function updateTooltipPosition(event) {
            const tooltip = d3.select('.tooltip');
            tooltip
                .style('left', (event.pageX + 10) + 'px')
                .style('top', (event.pageY - 10) + 'px');
        }

        function hideTooltip() {
            d3.select('.tooltip').style('display', 'none');
        }

        //  Event Handlers 
        d3.selectAll('.toggle-btn').on('click', function() {
            const mode = d3.select(this).attr('data-type');
            currentMode = mode;

            d3.selectAll('.toggle-btn').classed('active', false);
            d3.select(this).classed('active', true);

            drawMatrix();
        });

        // Load Data
        d3.csv('./temperature_daily.csv').then(rawData => {
            data = rawData;
            processData(data);
            initLegendGradient();
            drawMatrix();
        }).catch(error => {
            console.error('Error loading data:', error);
            alert('Failed to load temperature data. Make sure temperature_daily.csv is in the same directory.');
        });

        // Handle browser resize
        window.addEventListener('resize', drawMatrix);
    </script>
</body>
</html>
